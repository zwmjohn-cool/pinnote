name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Build app
        run: |
          xcodebuild -project pinnote.xcodeproj \
            -scheme pinnote \
            -configuration Release \
            -derivedDataPath ./build \
            -arch arm64 \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Create DMG
        run: |
          # 查找生成的.app文件
          APP_PATH=$(find ./build -name "pinnote.app" -type d | head -n 1)
          echo "Found app at: $APP_PATH"

          # 创建临时DMG目录
          mkdir -p dmg_temp

          # 复制.app到临时目录
          cp -R "$APP_PATH" dmg_temp/

          # 创建应用程序文件夹的符号链接，方便用户安装
          ln -s /Applications dmg_temp/Applications

          # 创建DMG
          hdiutil create -volname "PinNote" \
            -srcfolder dmg_temp \
            -ov \
            -format UDZO \
            pinnote-macos.dmg

          echo "DMG created successfully"
          ls -lh pinnote-macos.dmg

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: false
          body: |
            ## PinNote ${{ steps.get_version.outputs.VERSION }}

            ### 安装说明
            1. 下载 `pinnote-macos.dmg`
            2. 双击打开 DMG 文件
            3. 将 `pinnote.app` 拖到 `Applications` 文件夹
            4. 首次打开可能需要在系统设置中允许运行（右键点击应用选择"打开"）

            ### What's Changed
            查看提交记录了解详细更新内容

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./pinnote-macos.dmg
          asset_name: pinnote-macos.dmg
          asset_content_type: application/x-apple-diskimage
